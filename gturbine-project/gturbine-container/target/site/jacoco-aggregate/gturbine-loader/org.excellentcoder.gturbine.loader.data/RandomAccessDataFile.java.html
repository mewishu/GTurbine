<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>RandomAccessDataFile.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">gturbine-container</a> &gt; <a href="../index.html" class="el_bundle">gturbine-loader</a> &gt; <a href="index.source.html" class="el_package">org.excellentcoder.gturbine.loader.data</a> &gt; <span class="el_source">RandomAccessDataFile.java</span></div><h1>RandomAccessDataFile.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.excellentcoder.gturbine.loader.data;

import java.io.EOFException;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.RandomAccessFile;

/**
 * {@link RandomAccessData} implementation backed by a {@link RandomAccessFile}.
 *
 * @author Phillip Webb
 * @author Andy Wilkinson
 * @since 1.0.0
 */
public class RandomAccessDataFile implements RandomAccessData {

    private final FileAccess fileAccess;

    private final long       offset;

    private final long       length;

    /**
     * Create a new {@link RandomAccessDataFile} backed by the specified file.
     * @param file the underlying file
     * @throws IllegalArgumentException if the file is null or does not exist
     */
<span class="nc" id="L46">    public RandomAccessDataFile(File file) {</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (file == null) {</span>
<span class="nc" id="L48">            throw new IllegalArgumentException(&quot;File must not be null&quot;);</span>
        }
<span class="nc" id="L50">        this.fileAccess = new FileAccess(file);</span>
<span class="nc" id="L51">        this.offset = 0L;</span>
<span class="nc" id="L52">        this.length = file.length();</span>
<span class="nc" id="L53">    }</span>

    /**
     * Private constructor used to create a {@link #getSubsection(long, long) subsection}.
     * @param fileAccess provides access to the underlying file
     * @param offset the offset of the section
     * @param length the length of the section
     */
<span class="nc" id="L61">    private RandomAccessDataFile(FileAccess fileAccess, long offset, long length) {</span>
<span class="nc" id="L62">        this.fileAccess = fileAccess;</span>
<span class="nc" id="L63">        this.offset = offset;</span>
<span class="nc" id="L64">        this.length = length;</span>
<span class="nc" id="L65">    }</span>

    /**
     * Returns the underlying File.
     * @return the underlying file
     */
    public File getFile() {
<span class="nc" id="L72">        return this.fileAccess.file;</span>
    }

    @Override
    public InputStream getInputStream() throws IOException {
<span class="nc" id="L77">        return new DataInputStream();</span>
    }

    @Override
    public RandomAccessData getSubsection(long offset, long length) {
<span class="nc bnc" id="L82" title="All 6 branches missed.">        if (offset &lt; 0 || length &lt; 0 || offset + length &gt; this.length) {</span>
<span class="nc" id="L83">            throw new IndexOutOfBoundsException();</span>
        }
<span class="nc" id="L85">        return new RandomAccessDataFile(this.fileAccess, this.offset + offset, length);</span>
    }

    @Override
    public byte[] read() throws IOException {
<span class="nc" id="L90">        return read(0, this.length);</span>
    }

    @Override
    public byte[] read(long offset, long length) throws IOException {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (offset &gt; this.length) {</span>
<span class="nc" id="L96">            throw new IndexOutOfBoundsException();</span>
        }
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (offset + length &gt; this.length) {</span>
<span class="nc" id="L99">            throw new EOFException();</span>
        }
<span class="nc" id="L101">        byte[] bytes = new byte[(int) length];</span>
<span class="nc" id="L102">        read(bytes, offset, 0, bytes.length);</span>
<span class="nc" id="L103">        return bytes;</span>
    }

    private int readByte(long position) throws IOException {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (position &gt;= this.length) {</span>
<span class="nc" id="L108">            return -1;</span>
        }
<span class="nc" id="L110">        return this.fileAccess.readByte(this.offset + position);</span>
    }

    private int read(byte[] bytes, long position, int offset, int length) throws IOException {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (position &gt; this.length) {</span>
<span class="nc" id="L115">            return -1;</span>
        }
<span class="nc" id="L117">        return this.fileAccess.read(bytes, this.offset + position, offset, length);</span>
    }

    @Override
    public long getSize() {
<span class="nc" id="L122">        return this.length;</span>
    }

    public void close() throws IOException {
<span class="nc" id="L126">        this.fileAccess.close();</span>
<span class="nc" id="L127">    }</span>

    /**
     * {@link InputStream} implementation for the {@link RandomAccessDataFile}.
     */
<span class="nc" id="L132">    private class DataInputStream extends InputStream {</span>

        private int position;

        @Override
        public int read() throws IOException {
<span class="nc" id="L138">            int read = RandomAccessDataFile.this.readByte(this.position);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (read &gt; -1) {</span>
<span class="nc" id="L140">                moveOn(1);</span>
            }
<span class="nc" id="L142">            return read;</span>
        }

        @Override
        public int read(byte[] b) throws IOException {
<span class="nc bnc" id="L147" title="All 2 branches missed.">            return read(b, 0, (b != null) ? b.length : 0);</span>
        }

        @Override
        public int read(byte[] b, int off, int len) throws IOException {
<span class="nc bnc" id="L152" title="All 2 branches missed.">            if (b == null) {</span>
<span class="nc" id="L153">                throw new NullPointerException(&quot;Bytes must not be null&quot;);</span>
            }
<span class="nc" id="L155">            return doRead(b, off, len);</span>
        }

        /**
         * Perform the actual read.
         * @param b the bytes to read or {@code null} when reading a single byte
         * @param off the offset of the byte array
         * @param len the length of data to read
         * @return the number of bytes read into {@code b} or the actual read byte if
         * {@code b} is {@code null}. Returns -1 when the end of the stream is reached
         * @throws IOException in case of I/O errors
         */
        int doRead(byte[] b, int off, int len) throws IOException {
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (len == 0) {</span>
<span class="nc" id="L169">                return 0;</span>
            }
<span class="nc" id="L171">            int cappedLen = cap(len);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (cappedLen &lt;= 0) {</span>
<span class="nc" id="L173">                return -1;</span>
            }
<span class="nc" id="L175">            return (int) moveOn(RandomAccessDataFile.this.read(b, this.position, off, cappedLen));</span>
        }

        @Override
        public long skip(long n) throws IOException {
<span class="nc bnc" id="L180" title="All 2 branches missed.">            return (n &lt;= 0) ? 0 : moveOn(cap(n));</span>
        }

        /**
         * Cap the specified value such that it cannot exceed the number of bytes
         * remaining.
         * @param n the value to cap
         * @return the capped value
         */
        private int cap(long n) {
<span class="nc" id="L190">            return (int) Math.min(RandomAccessDataFile.this.length - this.position, n);</span>
        }

        /**
         * Move the stream position forwards the specified amount.
         * @param amount the amount to move
         * @return the amount moved
         */
        private long moveOn(int amount) {
<span class="nc" id="L199">            this.position += amount;</span>
<span class="nc" id="L200">            return amount;</span>
        }

    }

    private static final class FileAccess {

<span class="nc" id="L207">        private final Object     monitor = new Object();</span>

        private final File       file;

        private RandomAccessFile randomAccessFile;

<span class="nc" id="L213">        private FileAccess(File file) {</span>
<span class="nc" id="L214">            this.file = file;</span>
<span class="nc" id="L215">            openIfNecessary();</span>
<span class="nc" id="L216">        }</span>

        private int read(byte[] bytes, long position, int offset, int length) throws IOException {
<span class="nc" id="L219">            synchronized (this.monitor) {</span>
<span class="nc" id="L220">                openIfNecessary();</span>
<span class="nc" id="L221">                this.randomAccessFile.seek(position);</span>
<span class="nc" id="L222">                return this.randomAccessFile.read(bytes, offset, length);</span>
<span class="nc" id="L223">            }</span>
        }

        private void openIfNecessary() {
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (this.randomAccessFile == null) {</span>
                try {
<span class="nc" id="L229">                    this.randomAccessFile = new RandomAccessFile(this.file, &quot;r&quot;);</span>
<span class="nc" id="L230">                } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L231">                    throw new IllegalArgumentException(String.format(&quot;File %s must exist&quot;,</span>
<span class="nc" id="L232">                        this.file.getAbsolutePath()));</span>
<span class="nc" id="L233">                }</span>
            }
<span class="nc" id="L235">        }</span>

        private void close() throws IOException {
<span class="nc" id="L238">            synchronized (this.monitor) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                if (this.randomAccessFile != null) {</span>
<span class="nc" id="L240">                    this.randomAccessFile.close();</span>
<span class="nc" id="L241">                    this.randomAccessFile = null;</span>
                }
<span class="nc" id="L243">            }</span>
<span class="nc" id="L244">        }</span>

        private int readByte(long position) throws IOException {
<span class="nc" id="L247">            synchronized (this.monitor) {</span>
<span class="nc" id="L248">                openIfNecessary();</span>
<span class="nc" id="L249">                this.randomAccessFile.seek(position);</span>
<span class="nc" id="L250">                return this.randomAccessFile.read();</span>
<span class="nc" id="L251">            }</span>
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>