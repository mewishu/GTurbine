<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LaunchedURLClassLoader.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">gturbine-container</a> &gt; <a href="../index.html" class="el_bundle">gturbine-loader</a> &gt; <a href="index.source.html" class="el_package">org.excellentcoder.gturbine.loader</a> &gt; <span class="el_source">LaunchedURLClassLoader.java</span></div><h1>LaunchedURLClassLoader.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.excellentcoder.gturbine.loader;

import java.io.IOException;
import java.net.JarURLConnection;
import java.net.URL;
import java.net.URLClassLoader;
import java.net.URLConnection;
import java.security.AccessController;
import java.security.PrivilegedExceptionAction;
import java.util.Enumeration;
import java.util.jar.JarFile;

import org.excellentcoder.gturbine.loader.jar.Handler;

/**
 * URLClassLoader����ͨ��ԭʼ��jarЭ�飬����jar�д�class�ļ�
 * LaunchedURLClassLoader ͨ����չ��jarЭ�飬��ʵ��jar in jar��������µ�class�ļ�����
 *
 * {@link ClassLoader} used by the {@link Launcher}.
 *
 * ����findResource:
 * ������ʱ����Class.getResource():URL����ȡ��Ӧ����Դ�ļ�����Class.getResource()��ͨ��ί�и�ClassLoader��getResource()ʵ�ֵġ�
 *
 *
 * @author Phillip Webb
 * @author Dave Syer
 * @author Andy Wilkinson
 * @since 1.0.0
 */
public class LaunchedURLClassLoader extends URLClassLoader {

    static {
<span class="nc" id="L49">        ClassLoader.registerAsParallelCapable();</span>
<span class="nc" id="L50">    }</span>

    /**
     * Create a new {@link LaunchedURLClassLoader} instance.
     * @param urls the URLs from which to load classes and resources
     * @param parent the parent class loader for delegation
     */
    public LaunchedURLClassLoader(URL[] urls, ClassLoader parent) {
<span class="nc" id="L58">        super(urls, parent);</span>
<span class="nc" id="L59">    }</span>

    @Override
    public URL findResource(String name) {
<span class="nc" id="L63">        Handler.setUseFastConnectionExceptions(true);</span>
        try {
<span class="nc" id="L65">            return super.findResource(name);</span>
        } finally {
<span class="nc" id="L67">            Handler.setUseFastConnectionExceptions(false);</span>
        }
    }

    @Override
    public Enumeration&lt;URL&gt; findResources(String name) throws IOException {
<span class="nc" id="L73">        Handler.setUseFastConnectionExceptions(true);</span>
        try {
<span class="nc" id="L75">            return new UseFastConnectionExceptionsEnumeration(super.findResources(name));</span>
        } finally {
<span class="nc" id="L77">            Handler.setUseFastConnectionExceptions(false);</span>
        }
    }

    @Override
    protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException {
<span class="nc" id="L83">        Handler.setUseFastConnectionExceptions(true);</span>
        try {
            try {
<span class="nc" id="L86">                definePackageIfNecessary(name);</span>
<span class="nc" id="L87">            } catch (IllegalArgumentException ex) {</span>
                // Tolerate race condition due to being parallel capable
<span class="nc bnc" id="L89" title="All 2 branches missed.">                if (getPackage(name) == null) {</span>
                    // This should never happen as the IllegalArgumentException indicates
                    // that the package has already been defined and, therefore,
                    // getPackage(name) should not return null.
<span class="nc" id="L93">                    throw new AssertionError(</span>
                        &quot;Package &quot; + name + &quot; has already been defined but it could not be found&quot;);
                }
<span class="nc" id="L96">            }</span>
<span class="nc" id="L97">            return super.loadClass(name, resolve);</span>
        } finally {
<span class="nc" id="L99">            Handler.setUseFastConnectionExceptions(false);</span>
        }
    }

    /**
     * Define a package before a {@code findClass} call is made. This is necessary to
     * ensure that the appropriate manifest for nested JARs is associated with the
     * package.
     * @param className the class name being found
     */
    private void definePackageIfNecessary(String className) {
<span class="nc" id="L110">        int lastDot = className.lastIndexOf('.');</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (lastDot &gt;= 0) {</span>
<span class="nc" id="L112">            String packageName = className.substring(0, lastDot);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (getPackage(packageName) == null) {</span>
                try {
<span class="nc" id="L115">                    definePackage(className, packageName);</span>
<span class="nc" id="L116">                } catch (IllegalArgumentException ex) {</span>
                    // Tolerate race condition due to being parallel capable
<span class="nc bnc" id="L118" title="All 2 branches missed.">                    if (getPackage(packageName) == null) {</span>
                        // This should never happen as the IllegalArgumentException
                        // indicates that the package has already been defined and,
                        // therefore, getPackage(name) should not have returned null.
<span class="nc" id="L122">                        throw new AssertionError(</span>
                            &quot;Package &quot; + packageName
                                    + &quot; has already been defined but it could not be found&quot;);
                    }
<span class="nc" id="L126">                }</span>
            }
        }
<span class="nc" id="L129">    }</span>

    private void definePackage(String className, String packageName) {
        try {
<span class="nc" id="L133">            AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; {</span>
<span class="nc" id="L134">                String packageEntryName = packageName.replace('.', '/') + &quot;/&quot;;</span>
<span class="nc" id="L135">                String classEntryName = className.replace('.', '/') + &quot;.class&quot;;</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                for (URL url : getURLs()) {</span>
                    try {
<span class="nc" id="L138">                        URLConnection connection = url.openConnection();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                        if (connection instanceof JarURLConnection) {</span>
<span class="nc" id="L140">                            JarFile jarFile = ((JarURLConnection) connection).getJarFile();</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">                            if (jarFile.getEntry(classEntryName) != null &amp;&amp; jarFile.getEntry(packageEntryName) != null</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                                    &amp;&amp; jarFile.getManifest() != null) {</span>
<span class="nc" id="L143">                                definePackage(packageName, jarFile.getManifest(), url);</span>
<span class="nc" id="L144">                                return null;</span>
                            }
                        }
                    }
<span class="nc" id="L148">                    catch (IOException ex) {</span>
                        // Ignore
<span class="nc" id="L150">                    }</span>
                }
<span class="nc" id="L152">                return null;</span>
<span class="nc" id="L153">            }, AccessController.getContext());</span>
        }
<span class="nc" id="L155">        catch (java.security.PrivilegedActionException ex) {</span>
            // Ignore
<span class="nc" id="L157">        }</span>
<span class="nc" id="L158">    }</span>

    /**
     * Clear URL caches.
     */
    public void clearCache() {
<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (URL url : getURLs()) {</span>
            try {
<span class="nc" id="L166">                URLConnection connection = url.openConnection();</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (connection instanceof JarURLConnection) {</span>
<span class="nc" id="L168">                    clearCache(connection);</span>
                }
<span class="nc" id="L170">            } catch (IOException ex) {</span>
                // Ignore
<span class="nc" id="L172">            }</span>
        }

<span class="nc" id="L175">    }</span>

    private void clearCache(URLConnection connection) throws IOException {
<span class="nc" id="L178">        Object jarFile = ((JarURLConnection) connection).getJarFile();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if (jarFile instanceof org.excellentcoder.gturbine.loader.jar.JarFile) {</span>
<span class="nc" id="L180">            ((org.excellentcoder.gturbine.loader.jar.JarFile) jarFile).clearCache();</span>
        }
<span class="nc" id="L182">    }</span>

    private static class UseFastConnectionExceptionsEnumeration implements Enumeration&lt;URL&gt; {

        private final Enumeration&lt;URL&gt; delegate;

<span class="nc" id="L188">        UseFastConnectionExceptionsEnumeration(Enumeration&lt;URL&gt; delegate) {</span>
<span class="nc" id="L189">            this.delegate = delegate;</span>
<span class="nc" id="L190">        }</span>

        @Override
        public boolean hasMoreElements() {
<span class="nc" id="L194">            Handler.setUseFastConnectionExceptions(true);</span>
            try {
<span class="nc" id="L196">                return this.delegate.hasMoreElements();</span>
            } finally {
<span class="nc" id="L198">                Handler.setUseFastConnectionExceptions(false);</span>
            }

        }

        @Override
        public URL nextElement() {
<span class="nc" id="L205">            Handler.setUseFastConnectionExceptions(true);</span>
            try {
<span class="nc" id="L207">                return this.delegate.nextElement();</span>
            } finally {
<span class="nc" id="L209">                Handler.setUseFastConnectionExceptions(false);</span>
            }
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>