<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JarFileArchive.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">gturbine-bootstrap</a> &gt; <a href="../index.html" class="el_bundle">gturbine-loader</a> &gt; <a href="index.source.html" class="el_package">org.excellentcoder.gturbine.loader.archive</a> &gt; <span class="el_source">JarFileArchive.java</span></div><h1>JarFileArchive.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.excellentcoder.gturbine.loader.archive;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Enumeration;
import java.util.Iterator;
import java.util.List;
import java.util.UUID;
import java.util.jar.JarEntry;
import java.util.jar.Manifest;

import org.excellentcoder.gturbine.loader.jar.JarFile;

/**
 * {@link Archive} implementation backed by a {@link JarFile}.
 *
 * @author Phillip Webb
 * @author Andy Wilkinson
 * @since 1.0.0
 */
public class JarFileArchive implements Archive {

    private static final String UNPACK_MARKER = &quot;UNPACK:&quot;;

    private static final int    BUFFER_SIZE   = 32 * 1024;

    private final JarFile       jarFile;

    private URL                 url;

    private File                tempUnpackFolder;

    public JarFileArchive(File file) throws IOException {
<span class="nc" id="L57">        this(file, file.toURI().toURL());</span>
<span class="nc" id="L58">    }</span>

    public JarFileArchive(File file, URL url) throws IOException {
<span class="nc" id="L61">        this(new JarFile(file));</span>
<span class="nc" id="L62">        this.url = url;</span>
<span class="nc" id="L63">    }</span>

<span class="nc" id="L65">    public JarFileArchive(JarFile jarFile) {</span>
<span class="nc" id="L66">        this.jarFile = jarFile;</span>
<span class="nc" id="L67">    }</span>

    @Override
    public URL getUrl() throws MalformedURLException {
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (this.url != null) {</span>
<span class="nc" id="L72">            return this.url;</span>
        }
<span class="nc" id="L74">        return this.jarFile.getUrl();</span>
    }

    @Override
    public Manifest getManifest() throws IOException {
<span class="nc" id="L79">        return this.jarFile.getManifest();</span>
    }

    @Override
    public List&lt;Archive&gt; getNestedArchives(EntryFilter filter) throws IOException {
<span class="nc" id="L84">        List&lt;Archive&gt; nestedArchives = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        for (Entry entry : this) {</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (filter.matches(entry)) {</span>
<span class="nc" id="L87">                nestedArchives.add(getNestedArchive(entry));</span>
            }
<span class="nc" id="L89">        }</span>
<span class="nc" id="L90">        return Collections.unmodifiableList(nestedArchives);</span>
    }

    @Override
    public Iterator&lt;Entry&gt; iterator() {
<span class="nc" id="L95">        return new EntryIterator(this.jarFile.entries());</span>
    }

    @Override
    public void close() throws IOException {
<span class="nc" id="L100">        this.jarFile.close();</span>
<span class="nc" id="L101">    }</span>

    protected Archive getNestedArchive(Entry entry) throws IOException {
<span class="nc" id="L104">        JarEntry jarEntry = ((JarFileEntry) entry).getJarEntry();</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (jarEntry.getComment().startsWith(UNPACK_MARKER)) {</span>
<span class="nc" id="L106">            return getUnpackedNestedArchive(jarEntry);</span>
        }
        try {
<span class="nc" id="L109">            JarFile jarFile = this.jarFile.getNestedJarFile(jarEntry);</span>
<span class="nc" id="L110">            return new JarFileArchive(jarFile);</span>
<span class="nc" id="L111">        } catch (Exception ex) {</span>
<span class="nc" id="L112">            throw new IllegalStateException(&quot;Failed to get nested archive for entry &quot;</span>
<span class="nc" id="L113">                                            + entry.getName(), ex);</span>
        }
    }

    private Archive getUnpackedNestedArchive(JarEntry jarEntry) throws IOException {
<span class="nc" id="L118">        String name = jarEntry.getName();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (name.lastIndexOf('/') != -1) {</span>
<span class="nc" id="L120">            name = name.substring(name.lastIndexOf('/') + 1);</span>
        }
<span class="nc" id="L122">        File file = new File(getTempUnpackFolder(), name);</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">        if (!file.exists() || file.length() != jarEntry.getSize()) {</span>
<span class="nc" id="L124">            unpack(jarEntry, file);</span>
        }
<span class="nc" id="L126">        return new JarFileArchive(file, file.toURI().toURL());</span>
    }

    private File getTempUnpackFolder() {
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (this.tempUnpackFolder == null) {</span>
<span class="nc" id="L131">            File tempFolder = new File(System.getProperty(&quot;java.io.tmpdir&quot;));</span>
<span class="nc" id="L132">            this.tempUnpackFolder = createUnpackFolder(tempFolder);</span>
        }
<span class="nc" id="L134">        return this.tempUnpackFolder;</span>
    }

    private File createUnpackFolder(File parent) {
<span class="nc" id="L138">        int attempts = 0;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        while (attempts++ &lt; 1000) {</span>
<span class="nc" id="L140">            String fileName = new File(this.jarFile.getName()).getName();</span>
<span class="nc" id="L141">            File unpackFolder = new File(parent, fileName + &quot;-spring-boot-libs-&quot;</span>
<span class="nc" id="L142">                                                 + UUID.randomUUID());</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (unpackFolder.mkdirs()) {</span>
<span class="nc" id="L144">                return unpackFolder;</span>
            }
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">        throw new IllegalStateException(&quot;Failed to create unpack folder in directory '&quot; + parent</span>
                                        + &quot;'&quot;);
    }

    private void unpack(JarEntry entry, File file) throws IOException {
<span class="nc" id="L152">        try (InputStream inputStream = this.jarFile.getInputStream(entry);</span>
<span class="nc" id="L153">                OutputStream outputStream = new FileOutputStream(file)) {</span>
<span class="nc" id="L154">            byte[] buffer = new byte[BUFFER_SIZE];</span>
            int bytesRead;
<span class="nc bnc" id="L156" title="All 2 branches missed.">            while ((bytesRead = inputStream.read(buffer)) != -1) {</span>
<span class="nc" id="L157">                outputStream.write(buffer, 0, bytesRead);</span>
            }
<span class="nc" id="L159">            outputStream.flush();</span>
<span class="nc bnc" id="L160" title="All 16 branches missed.">        }</span>
<span class="nc" id="L161">    }</span>

    @Override
    public String toString() {
        try {
<span class="nc" id="L166">            return getUrl().toString();</span>
<span class="nc" id="L167">        } catch (Exception ex) {</span>
<span class="nc" id="L168">            return &quot;jar archive&quot;;</span>
        }
    }

    /**
     * {@link Archive.Entry} iterator implementation backed by {@link JarEntry}.
     */
    private static class EntryIterator implements Iterator&lt;Entry&gt; {

        private final Enumeration&lt;JarEntry&gt; enumeration;

<span class="nc" id="L179">        EntryIterator(Enumeration&lt;JarEntry&gt; enumeration) {</span>
<span class="nc" id="L180">            this.enumeration = enumeration;</span>
<span class="nc" id="L181">        }</span>

        @Override
        public boolean hasNext() {
<span class="nc" id="L185">            return this.enumeration.hasMoreElements();</span>
        }

        @Override
        public Entry next() {
<span class="nc" id="L190">            return new JarFileEntry(this.enumeration.nextElement());</span>
        }

        @Override
        public void remove() {
<span class="nc" id="L195">            throw new UnsupportedOperationException(&quot;remove&quot;);</span>
        }

    }

    /**
     * {@link Archive.Entry} implementation backed by a {@link JarEntry}.
     */
    private static class JarFileEntry implements Entry {

        private final JarEntry jarEntry;

<span class="nc" id="L207">        JarFileEntry(JarEntry jarEntry) {</span>
<span class="nc" id="L208">            this.jarEntry = jarEntry;</span>
<span class="nc" id="L209">        }</span>

        JarEntry getJarEntry() {
<span class="nc" id="L212">            return this.jarEntry;</span>
        }

        @Override
        public boolean isDirectory() {
<span class="nc" id="L217">            return this.jarEntry.isDirectory();</span>
        }

        @Override
        public String getName() {
<span class="nc" id="L222">            return this.jarEntry.getName();</span>
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>